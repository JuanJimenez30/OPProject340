<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/Login.css">
    <title>Log In</title>
</head>
<body>
      
    <div id="login-container">
    <!-- <h1>Log In </h1> -->
    <form id="loginForm" action="#" >
        <h1>Log In </h1>
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" required><br><br>
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required><br><br>
        <button type="submit">Log In</button>
         <p>Don't have an account?</p>
    <button type="button" onclick="location.href='/Customer/SignUp.html'">Sign Up</button>
        </form>
        <script>
            // Login handler — attempts provider auth first, then falls back to customer auth
            (function(){
                const form = document.getElementById('loginForm');
                form.addEventListener('submit', async function(e){
                    e.preventDefault();
                    const fd = new FormData(form);
                    const username = (fd.get('username') || '').trim();
                    const password = (fd.get('password') || '').trim();

                    if(!username || !password){
                        alert('Please enter both username (or email) and password.');
                        return;
                    }

                    try{
                        // 1) Try provider authentication
                        const providerRes = await fetch('/api/providers/authenticate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username: username, password: password })
                        });

                        if(providerRes.ok){
                            const provider = await providerRes.json();
                            sessionStorage.setItem('glc_logged_in', 'true');
                            sessionStorage.setItem('glc_user', provider.email || provider.name || username);
                            sessionStorage.setItem('glc_role', 'provider');
                            if(provider.id) sessionStorage.setItem('glc_provider_id', String(provider.id));
                            window.location.href = '/Provider/Home.html';
                            return;
                        }

                        // If provider auth returned 401, try customer auth
                        if(providerRes.status === 401){
                            const customerRes = await fetch('/api/customers/login', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ username: username, password: password })
                            });

                            if(customerRes.ok){
                                const customer = await customerRes.json();
                                sessionStorage.setItem('glc_logged_in', 'true');
                                sessionStorage.setItem('glc_user', customer.email || customer.username || username);
                                sessionStorage.setItem('glc_role', 'customer');
                                if(customer.id){
                                    sessionStorage.setItem('glc_customer_id', String(customer.id));
                                    localStorage.setItem('customerId', String(customer.id));
                                }
                                window.location.href = '/Customer/CustomerHome.html';
                                return;
                            } else if (customerRes.status === 401){
                                alert('Invalid credentials.');
                                return;
                            } else if (customerRes.status === 400){
                                alert('Bad request to authentication endpoint.');
                                return;
                            } else {
                                const txt = await customerRes.text().catch(()=>'');
                                console.error('Customer auth error', customerRes.status, txt);
                                alert('Authentication failed — see console for details.');
                                return;
                            }
                        }

                        // providerRes was not ok and not 401
                        if(providerRes.status === 400){
                            alert('Bad request to authentication endpoint.');
                            return;
                        } else {
                            const txt = await providerRes.text().catch(()=>'');
                            console.error('Auth error', providerRes.status, txt);
                            alert('Authentication failed — see console for details.');
                            return;
                        }

                    }catch(err){
                        console.error('Network error during authentication', err);
                        alert('Network error — unable to contact authentication server.');
                    }
                });
            })();
        </script>
    </div>
</body>
</html>