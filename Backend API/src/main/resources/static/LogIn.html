<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/Login.css">
    <title>Log In</title>
</head>
<body>
      
    <div id="login-container">
    <!-- <h1>Log In </h1> -->
    <form id="loginForm" action="#" >
        <h1>Log In </h1>
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" required><br><br>
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required><br><br>
        <button type="submit">Log In</button>
         <p>Don't have an account?</p>
    <button type="button" onclick="location.href='/Customer/SignUp.html'">Sign Up</button>
        </form>
        <script>
            // Login handler — attempts server-side provider authentication, falls back to simple customer mock
            (function(){
                const form = document.getElementById('loginForm');
                form.addEventListener('submit', async function(e){
                    e.preventDefault();
                    const fd = new FormData(form);
                    const username = (fd.get('username') || '').trim();
                    const password = (fd.get('password') || '').trim();

                    if(!username || !password){
                        alert('Please enter both username (email) and password.');
                        return;
                    }

                    // Keep the simple in-page customer mock for demo customers
                    if(username === 'customer' && password === 'customer123'){
                        sessionStorage.setItem('glc_logged_in', 'true');
                        sessionStorage.setItem('glc_user', username);
                        sessionStorage.setItem('glc_role', 'customer');
                        window.location.href = '/Customer/CustomerHome.html';
                        return;
                    }

                    // Otherwise attempt provider authentication against the backend
                    try{
                        const res = await fetch('/api/providers/authenticate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username: username, password: password })
                        });

                        if(res.ok){
                            const provider = await res.json();
                            // store minimal session info in sessionStorage for the frontend
                            sessionStorage.setItem('glc_logged_in', 'true');
                            sessionStorage.setItem('glc_user', provider.email || provider.name || username);
                            sessionStorage.setItem('glc_role', 'provider');
                            // optional: store provider id
                            if(provider.id) sessionStorage.setItem('glc_provider_id', String(provider.id));
                            window.location.href = '/Provider/Home.html';
                            return;
                        } else if (res.status === 401) {
                            alert('Invalid provider credentials.');
                            return;
                        } else if (res.status === 400) {
                            alert('Bad request to authentication endpoint.');
                            return;
                        } else {
                            const txt = await res.text().catch(()=>'');
                            console.error('Auth error', res.status, txt);
                            alert('Authentication failed — see console for details.');
                            return;
                        }
                    }catch(err){
                        console.error('Network error during authentication', err);
                        alert('Network error — unable to contact authentication server.');
                    }
                });
            })();
        </script>
    </div>
</body>
</html>